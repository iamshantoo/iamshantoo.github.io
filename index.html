<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Md. Abul Hasan | Game Dev Portfolio</title>
    
    <!-- FAVICON: A pixel art Game Controller -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 16%22><path fill=%22%232c3e50%22 d=%22M2 6h12v6H2z%22/><path fill=%22%2395a5a6%22 d=%22M3 5h2v1H3zM11 5h2v1h-2z%22/><path fill=%22%23e74c3c%22 d=%22M12 8h1v1h-1z%22/><path fill=%22%23f1c40f%22 d=%22M10 9h1v1h-1z%22/><path fill=%22%23ecf0f1%22 d=%22M4 8h1v1H4zM3 9h1v1H3zM5 9h1v1H5zM4 10h1v1H4z%22/></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        /* CORE SETUP */
        html, body {
            height: 100%; 
            width: 100%;
        }
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000000; /* Start black */
            font-family: 'VT323', monospace; 
            touch-action: none; 
            user-select: none; 
            -webkit-user-select: none;
            transition: background-color 0.5s ease;
        }
        canvas {
            display: block;
            image-rendering: pixelated; 
        }
        
        /* UI LAYERS */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 20;
        }

        /* MODAL */
        .modal-container {
            pointer-events: auto;
            background: rgba(10, 10, 15, 0.95);
            border: 4px solid #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            max-width: 650px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto; 
            color: #fff;
            padding: 24px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100;
            -webkit-overflow-scrolling: touch; 
            font-family: 'VT323', monospace; 
        }

        @keyframes popIn {
            from { transform: translate(-50%, -45%) scale(0.9); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* SCANLINE OVERLAY */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
        }

        /* CONTROLS (Mobile Only) */
        .d-pad {
            pointer-events: auto;
            position: absolute;
            bottom: 30px;
            left: 30px;
            width: 160px;
            height: 160px;
            display: none; /* Hidden by default */
            z-index: 50;
            opacity: 0.8;
        }
        
        .d-pad-bg { position: absolute; width: 100%; height: 100%; }
        .d-pad-btn {
            position: absolute;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255,255,255,0.4);
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            backdrop-filter: blur(2px);
        }
        .d-pad-btn.active { background: rgba(255, 255, 255, 0.5); box-shadow: 0 0 10px white; }
        
        .btn-up { top: 0; left: 53px; width: 54px; height: 53px; border-radius: 10px 10px 0 0; border-bottom: none; }
        .btn-down { bottom: 0; left: 53px; width: 54px; height: 53px; border-radius: 0 0 10px 10px; border-top: none; }
        .btn-left { top: 53px; left: 0; width: 53px; height: 54px; border-radius: 10px 0 0 10px; border-right: none; }
        .btn-right { top: 53px; right: 0; width: 53px; height: 54px; border-radius: 0 10px 10px 0; border-left: none; }
        .d-pad-center { top: 53px; left: 53px; width: 54px; height: 54px; background: rgba(255,255,255,0.15); }

        .action-btn {
            pointer-events: auto;
            position: absolute;
            bottom: 50px;
            right: 40px;
            width: 90px;
            height: 90px;
            background: rgba(255, 50, 50, 0.3);
            border: 4px solid rgba(255,255,255,0.8);
            border-radius: 50%;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            font-size: 32px;
            font-weight: bold;
            color: white;
            z-index: 50;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            font-family: 'VT323', monospace;
        }
        .action-btn:active { background: rgba(255, 50, 50, 0.6); transform: scale(0.95); }

        /* TEXT UTILS */
        .pixel-text { text-shadow: 2px 2px 0px #000; letter-spacing: 1px; }
        
        .notification {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 12px 24px;
            border: 2px solid #fff;
            font-size: 1.5rem;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            white-space: nowrap;
            z-index: 40;
            border-radius: 8px;
        }

        #modal-content a { color: #60a5fa; text-decoration: none; border-bottom: 1px dashed #60a5fa; }
        #modal-content a:hover { color: #93c5fd; border-bottom: 1px solid #93c5fd; }
        #modal-content ul { list-style-type: square; padding-left: 20px; } /* Restored list style */
        #modal-content li { margin-bottom: 8px; }
        #modal-content strong { color: #fbbf24; font-weight: normal; letter-spacing: 0.5px; }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="notification" class="notification pixel-text">Press SPACE to Interact</div>

        <!-- Intro Screen -->
        <div id="intro-screen" class="absolute inset-0 bg-black flex flex-col items-center justify-center z-50 pointer-events-auto p-4">
            <h1 class="text-5xl md:text-7xl text-white mb-2 pixel-text text-center text-yellow-400 leading-tight">UNITY QUEST</h1>
            <p class="text-2xl md:text-3xl text-blue-300 mb-6 pixel-text text-center">Md. Abul Hasan</p>
            
            <!-- Intro Panel -->
            <div class="bg-gray-900 border-2 border-gray-600 p-6 rounded-lg max-w-md w-full mb-8">
                <p class="text-2xl text-gray-300 mb-6 pixel-text text-center">Game Developer | AR/VR/XR Expert</p>
                
                <div id="controls-hint" class="flex justify-center gap-8 text-gray-400 text-xl pixel-text">
                    <!-- JS will populate this -->
                </div>
            </div>

            <button onclick="startGame()" class="px-10 py-4 bg-blue-600 text-white border-4 border-white hover:bg-blue-500 hover:border-blue-200 font-bold text-3xl pixel-text animate-pulse shadow-[0_0_20px_rgba(37,99,235,0.5)] transition-all transform hover:scale-105">
                START GAME
            </button>
        </div>

        <!-- Content Modal -->
        <div id="modal" class="modal-container">
            <div class="flex justify-between items-start mb-6 border-b-2 border-gray-700 pb-4 sticky top-0 bg-[#0a0a0f] z-10">
                <h2 id="modal-title" class="text-4xl text-yellow-400 pixel-text tracking-wide">Title</h2>
                <button onclick="closeModal()" class="text-red-500 hover:text-red-400 text-4xl font-bold px-2 pixel-text">X</button>
            </div>
            <div id="modal-content" class="text-2xl leading-relaxed space-y-4 text-gray-200 pixel-text">
                <!-- Content injected via JS -->
            </div>
            <div class="mt-8 pt-4 border-t border-gray-800 text-center text-gray-500 text-lg pixel-text uppercase">
                [ Click X or Press ESC to Close ]
            </div>
        </div>

        <!-- Mobile Controls -->
        <div id="mobile-dpad" class="d-pad">
            <div class="d-pad-bg">
                <div class="d-pad-btn d-pad-center"></div>
                <div id="btn-up" class="d-pad-btn btn-up"></div>
                <div id="btn-down" class="d-pad-btn btn-down"></div>
                <div id="btn-left" class="d-pad-btn btn-left"></div>
                <div id="btn-right" class="d-pad-btn btn-right"></div>
            </div>
        </div>
        <div id="mobile-action" class="action-btn" onclick="interact()">A</div>
    </div>

<script>
    /**
     * CONFIGURATION & ASSETS
     */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const TILE_SIZE = 48; 
    const PLAYER_SPEED = 4;
    
    // Game State
    let gameRunning = false;
    let isModalOpen = false;
    let lastTime = 0;
    let isMobile = false;
    
    // Camera
    let camera = { x: 0, y: 0 };

    // Player
    const player = {
        x: 0, 
        y: 0,
        width: 32,
        height: 32,
        color: '#ff4444',
        direction: 'down',
        moving: false,
        frame: 0
    };

    // Input State
    const keys = { w: false, a: false, s: false, d: false, Space: false };

    // Expanded Map Dimensions
    const MAP_WIDTH = 40; 
    const MAP_HEIGHT = 32; 
    
    let worldMap = [];
    
    function generateMap() {
        worldMap = [];
        for(let y=0; y<MAP_HEIGHT; y++) {
            let row = [];
            for(let x=0; x<MAP_WIDTH; x++) {
                // Base: Water
                let tile = 1; 
                
                // Main Island (Centered-ish)
                if (x > 3 && x < MAP_WIDTH - 4 && y > 3 && y < MAP_HEIGHT - 4) {
                    tile = 0; // Grass
                }
                
                // -- PATHWAYS --
                // Central Vertical Path
                if (x === 20 && y > 3 && y < MAP_HEIGHT - 4) tile = 2; 
                // Central Horizontal Path
                if (y === 15 && x > 3 && x < MAP_WIDTH - 4) tile = 2; 
                
                // -- ZONES --
                // House Area (North Center - Experience)
                if (x > 17 && x < 23 && y > 5 && y < 10) tile = 3; 

                // Education Area (South - Library)
                if (x > 15 && x < 25 && y > 22 && y < 27) tile = 3;

                row.push(tile);
            }
            worldMap.push(row);
        }
    }

    // Entities
    const entities = [
        // --- START (CENTER) ---
        { x: 20, y: 18, type: 'sign', color: '#8B4513', id: 'intro', title: 'Welcome!', content: 'Hi, I\'m <strong>Md. Abul Hasan</strong>.<br><br>I am an innovative Unity Developer with 4+ years of experience in creating multi-platform games, simulations, and AR/VR/XR applications.<br><br><strong>Explore:</strong><br>North: Work Experience<br>West: Skills & Awards<br>East: Projects Gallery<br>South: Education Library' },

        // --- NORTH: EXPERIENCE (OFFICE) ---
        { x: 18, y: 7, type: 'npc', color: '#4169E1', id: 'exp_singularity', title: 'Singularity Limited', content: '<strong>Experience Engineer</strong><br><em>Jan 2025 - Present</em><br><br><ul><li>Developing interactive simulations and immersive AR/VR/XR applications for commercial and research projects.</li><li>Collaborating with cross-functional teams to design, prototype, and deploy real-time 3D experiences.</li></ul>' },
        { x: 22, y: 7, type: 'npc', color: '#8e44ad', id: 'exp_battery', title: 'Battery Low Interactive', content: '<strong>Unity Developer & QA Engineer</strong><br><em>Sep 2021 - Jan 2025</em><br><br><ul><li>Designed and developed games, simulations, and AR/VR/XR experiences using Unity.</li><li>Transitioned to Lead Gameplay Programmer in 2023, focusing on performance optimization and hardware integration.</li></ul>' },

        // --- WEST: SKILLS & AWARDS (GARDEN) ---
        // Skills
        { x: 6, y: 7, type: 'statue', color: '#7f8c8d', id: 'skill_unity', title: 'Game Development', content: '<strong>Core Engines:</strong> Unity 3D/2D<br><strong>Languages:</strong> C#, C++, Python<br><strong>Key Skills:</strong> Gameplay Programming, Level Design, Optimization, Physics Simulation.' },
        { x: 6, y: 11, type: 'statue', color: '#7f8c8d', id: 'skill_arvr', title: 'AR / VR / XR', content: '<strong>SDKs:</strong> Meta SDK, Vuforia, ARFoundation, XR Interaction Toolkit, SnapAR, WebAR.<br><strong>Expertise:</strong> Immersive experiences, Real-time 3D, sensor integration.' },
        { x: 6, y: 15, type: 'statue', color: '#7f8c8d', id: 'skill_tools', title: 'Tools & Hardware', content: '<strong>Tools:</strong> Blender, Git, JIRA, Visual Studio, Adobe Creative Suite.<br><strong>Hardware:</strong> Arduino Programming, IoT Sensor Integration, Hardware-Software Bridges.' },
        
        // Awards
        { x: 10, y: 20, type: 'trophy', color: '#f1c40f', id: 'award_blockchain', title: 'Intl Blockchain Olympiad', content: '<strong>2021 Award Winner</strong><br><br>Document Authentication Category Winner at the International Blockchain Olympiad 2021.' },
        { x: 8, y: 20, type: 'trophy', color: '#f1c40f', id: 'award_hackathon', title: 'Hackathon Champion', content: '<strong>UAP CSE Carnival 2020</strong><br><br>Champion of the Hardware and Software Carnival Hackathon (24-hour sprint).' },

        // --- SOUTH: EDUCATION (LIBRARY) ---
        { x: 20, y: 24, type: 'sign', color: '#e67e22', id: 'edu_bsc', title: 'University (B.Sc)', content: '<strong>Bachelor of Science in CSE</strong><br><em>University of Asia Pacific</em> (2016-2021)<br><br><strong>CGPA:</strong> 2.92/4.00<br><strong>Key Activities:</strong> Hackathon Champion, Blockchain Olympiad Winner, Thesis on IoT.' },
        { x: 17, y: 24, type: 'bookshelf', color: '#d35400', id: 'edu_hsc', title: 'College (HSC)', content: '<strong>Higher Secondary Certificate</strong><br><em>Ghatail Cantonment College</em> (2014)<br><br><strong>Group:</strong> Science<br><strong>GPA:</strong> 4.10/5.00' },
        { x: 23, y: 24, type: 'bookshelf', color: '#d35400', id: 'edu_ssc', title: 'School (SSC)', content: '<strong>Secondary School Certificate</strong><br><em>Kadamtali Hasan Public High School</em> (2012)<br><br><strong>Group:</strong> Science<br><strong>GPA:</strong> 5.00/5.00' },

        // --- EAST: PROJECTS GALLERY (TREASURE ROOM) ---
        // Row 1: Recent AR/VR
        { x: 28, y: 6, type: 'chest', color: '#FFD700', id: 'proj_visa', title: 'VISA AR Photobooth', content: '<em>July 2025 - Aug 2025</em><br><br>Real-time photo capture system with multiple AR frames, QR generation, and Python-Unity bridge for printing.' },
        { x: 32, y: 6, type: 'chest', color: '#FFD700', id: 'proj_vr_sports', title: 'VR Sports Suite', content: '<em>2025 - Present</em><br><br><strong>VR Goalkeeper, VR Cricket:</strong><br>Immersive simulations focusing on realistic physics and VR interaction mechanics.' },
        
        // Row 2: Simulations & Hardware
        { x: 28, y: 10, type: 'chest', color: '#FFD700', id: 'proj_harvester', title: 'Harvester Simulator', content: '<em>2023 - 2024</em><br><br>Physics-based training simulator for Combined Harvesters using custom Arduino-based hardware controllers.' },
        { x: 32, y: 10, type: 'chest', color: '#FFD700', id: 'proj_drone', title: 'Drone Simulator', content: '<em>Nov 2024 - Jan 2025</em><br><br>Realistic drone flight simulation. Contributed to Level Design, Lighting, and Technical Art.' },
        
        // Row 3: WebGL & Mobile
        { x: 28, y: 14, type: 'chest', color: '#FFD700', id: 'proj_games_web', title: 'Web Games', content: '<strong>Chashi Nobanno:</strong> Casual cultural web game.<br><strong>2D Spin Wheel Cricket:</strong> WebGL sports game.<br><strong>Penalty Shootout:</strong> WebGL sports game.' },
        { x: 32, y: 14, type: 'chest', color: '#FFD700', id: 'proj_games_mobile', title: 'Mobile Games', content: '<strong>Android Casual Games:</strong> Multiple casual titles.<br><strong>Bangladesh AR:</strong> AR app using Vuforia.<br><strong>Memory Game:</strong> Puzzle game with hardware integration.' },

        // Row 4: Academic & Misc
        { x: 28, y: 18, type: 'chest', color: '#c0c0c0', id: 'proj_academic', title: 'Academic Projects', content: '<strong>Smart Factory (IoT):</strong> Industrial automation system (Thesis).<br><strong>Env Monitoring:</strong> IoT based system.<br><strong>E-Commerce:</strong> Django based website.' },
        { x: 32, y: 18, type: 'chest', color: '#c0c0c0', id: 'proj_virtual_gallery', title: 'Virtual Gallery', content: '<em>2023 - 2024</em><br><br>WebGL Virtual Gallery Exhibition. Worked on Level Design, Lighting, UI, and SFX.' },

        // --- CONTACT (SOUTH DOCK) ---
        { x: 20, y: 28, type: 'mailbox', color: '#c0392b', id: 'contact', title: 'Contact Me', content: 'Let\'s build the future together!<br><br><strong>Phone:</strong> +8801777148127<br><strong>Email:</strong> shantouap40@gmail.com<br><strong>LinkedIn:</strong> <a href="https://linkedin.com/in/iam-shanto" target="_blank">in/iam-shanto</a><br><strong>GitHub:</strong> <a href="https://github.com/iamshantoo" target="_blank">github.com/iamshantoo</a><br><strong>YouTube:</strong> @gamifyeverything' }
    ];

    /**
     * INITIALIZATION
     */
    function init() {
        checkDevice();
        generateMap();
        
        // Center Player spawn (Map Center is approx 20, 15)
        player.x = 20 * TILE_SIZE;
        player.y = 15 * TILE_SIZE;

        resize();
        window.addEventListener('resize', resize);
        
        setupMobileControls();
        setupDesktopControls();

        requestAnimationFrame(gameLoop);
    }

    function checkDevice() {
        // STRICTER Mobile Check: Touch capable AND Screen width < 1024px
        // This ensures desktops/laptops with touchscreens still get the Desktop UI
        isMobile = (('ontouchstart' in window) || (navigator.maxTouchPoints > 0)) && (window.innerWidth < 1024);
        
        const hints = document.getElementById('controls-hint');
        const notif = document.getElementById('notification');
        
        if (isMobile) {
            hints.innerHTML = `
                <div class="flex flex-col items-center"><span class="text-yellow-400">D-PAD</span><span>Move</span></div>
                <div class="flex flex-col items-center"><span class="text-yellow-400">A BUTTON</span><span>Interact</span></div>
            `;
            notif.innerText = "Tap 'A' to Interact";
        } else {
            hints.innerHTML = `
                <div class="flex flex-col items-center"><span class="border border-gray-500 px-2 py-1 rounded text-yellow-400">W,A,S,D</span><span>Move</span></div>
                <div class="flex flex-col items-center"><span class="border border-gray-500 px-2 py-1 rounded text-yellow-400">SPACE</span><span>Interact</span></div>
            `;
            notif.innerText = "Press SPACE to Interact";
        }
    }

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        ctx.imageSmoothingEnabled = false; 
    }

    function startGame() {
        document.getElementById('intro-screen').style.display = 'none';
        
        // SWITCH BACKGROUND COLOR TO WATER BLUE FOR INFINITE OCEAN EFFECT
        document.body.style.backgroundColor = '#3498db';

        // SHOW CONTROLS NOW if on mobile
        if(isMobile) {
            document.getElementById('mobile-dpad').style.display = 'block';
            document.getElementById('mobile-action').style.display = 'flex';
        }

        gameRunning = true;

        // FORCE CAMERA UPDATE TO SNAP TO PLAYER
        updateCamera();

        // --- AUTO-OPEN WELCOME MODAL ---
        const introEntity = entities.find(e => e.id === 'intro');
        if (introEntity) {
            openModal(introEntity);
        }
    }

    /**
     * CONTROLS
     */
    function setupDesktopControls() {
        window.addEventListener('keydown', (e) => {
            if(isModalOpen) {
                if (e.key === 'Escape') closeModal();
                return;
            }
            const key = e.key.toLowerCase();
            if (keys.hasOwnProperty(key)) keys[key] = true;
            if (e.code === 'Space') interact();
            if (['w','a','s','d','arrowup','arrowdown','arrowleft','arrowright'].includes(key)) gameRunning = true; 
            
            if(e.key === 'ArrowUp') keys.w = true;
            if(e.key === 'ArrowDown') keys.s = true;
            if(e.key === 'ArrowLeft') keys.a = true;
            if(e.key === 'ArrowRight') keys.d = true;
        });

        window.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            if (keys.hasOwnProperty(key)) keys[key] = false;
            
            if(e.key === 'ArrowUp') keys.w = false;
            if(e.key === 'ArrowDown') keys.s = false;
            if(e.key === 'ArrowLeft') keys.a = false;
            if(e.key === 'ArrowRight') keys.d = false;
        });
    }

    function setupMobileControls() {
        const dpad = document.getElementById('mobile-dpad');
        const btns = {
            up: document.getElementById('btn-up'),
            down: document.getElementById('btn-down'),
            left: document.getElementById('btn-left'),
            right: document.getElementById('btn-right')
        };

        const handleTouch = (e) => {
            e.preventDefault(); 
            const touch = e.touches[0];
            const rect = dpad.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;

            keys.w = keys.s = keys.a = keys.d = false;
            Object.values(btns).forEach(b => b.classList.remove('active'));

            const dx = x - 80;
            const dy = y - 80;
            const dist = Math.sqrt(dx*dx + dy*dy);

            if (dist > 15) { 
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                if (angle > -135 && angle < -45) { keys.w = true; btns.up.classList.add('active'); }
                else if (angle > 45 && angle < 135) { keys.s = true; btns.down.classList.add('active'); }
                else if (angle >= 135 || angle <= -135) { keys.a = true; btns.left.classList.add('active'); }
                else if (angle > -45 && angle < 45) { keys.d = true; btns.right.classList.add('active'); }
            }
            gameRunning = true;
        };

        const stopTouch = (e) => {
            e.preventDefault();
            keys.w = keys.s = keys.a = keys.d = false;
            Object.values(btns).forEach(b => b.classList.remove('active'));
        };

        dpad.addEventListener('touchstart', handleTouch, { passive: false });
        dpad.addEventListener('touchmove', handleTouch, { passive: false });
        dpad.addEventListener('touchend', stopTouch);
        
        document.addEventListener('dblclick', function(event) {
            event.preventDefault();
        }, { passive: false });
    }

    /**
     * GAME LOGIC
     */
    function update(dt) {
        if (!gameRunning || isModalOpen) return;

        let dx = 0;
        let dy = 0;

        if (keys.w) { dy = -PLAYER_SPEED; player.direction = 'up'; }
        if (keys.s) { dy = PLAYER_SPEED; player.direction = 'down'; }
        if (keys.a) { dx = -PLAYER_SPEED; player.direction = 'left'; }
        if (keys.d) { dx = PLAYER_SPEED; player.direction = 'right'; }

        if (dx !== 0 && dy !== 0) {
            dx *= 0.7071;
            dy *= 0.7071;
        }

        if (dx !== 0 || dy !== 0) {
            player.moving = true;
            player.frame += 0.2;
            movePlayer(dx, dy);
        } else {
            player.moving = false;
            player.frame = 0;
        }

        updateCamera();
        checkProximity();
    }

    function updateCamera() {
        const mapPixelWidth = MAP_WIDTH * TILE_SIZE;
        const mapPixelHeight = MAP_HEIGHT * TILE_SIZE;

        if (mapPixelWidth < canvas.width) {
            camera.x = -((canvas.width - mapPixelWidth) / 2);
        } else {
            const targetCamX = player.x - canvas.width / 2 + player.width / 2;
            camera.x = Math.max(0, Math.min(targetCamX, mapPixelWidth - canvas.width));
        }

        if (mapPixelHeight < canvas.height) {
            camera.y = -((canvas.height - mapPixelHeight) / 2);
        } else {
            const targetCamY = player.y - canvas.height / 2 + player.height / 2;
            camera.y = Math.max(0, Math.min(targetCamY, mapPixelHeight - canvas.height));
        }
    }

    function movePlayer(dx, dy) {
        const nextX = player.x + dx;
        const nextY = player.y + dy;
        
        if (!isSolid(nextX, player.y) && !isSolid(nextX + player.width, player.y) &&
            !isSolid(nextX, player.y + player.height) && !isSolid(nextX + player.width, player.y + player.height)) {
            player.x = nextX;
        }
        
        if (!isSolid(player.x, nextY) && !isSolid(player.x + player.width, nextY) &&
            !isSolid(player.x, nextY + player.height) && !isSolid(player.x + player.width, nextY + player.height)) {
            player.y = nextY;
        }
    }

    function isSolid(x, y) {
        if (x < 0 || x >= MAP_WIDTH * TILE_SIZE || y < 0 || y >= MAP_HEIGHT * TILE_SIZE) return true;
        
        const tileX = Math.floor(x / TILE_SIZE);
        const tileY = Math.floor(y / TILE_SIZE);
        const tile = worldMap[tileY][tileX];
        
        if (tile === 1) return true; // Water
        
        for (let ent of entities) {
            if (x > ent.x * TILE_SIZE + 5 && x < (ent.x + 1) * TILE_SIZE - 5 &&
                y > ent.y * TILE_SIZE + 10 && y < (ent.y + 1) * TILE_SIZE) {
                return true;
            }
        }
        return false;
    }

    function checkProximity() {
        const centerX = player.x + player.width/2;
        const centerY = player.y + player.height/2;
        let nearby = false;

        for (let ent of entities) {
            const entCenterX = (ent.x * TILE_SIZE) + (TILE_SIZE/2);
            const entCenterY = (ent.y * TILE_SIZE) + (TILE_SIZE/2);
            const dist = Math.hypot(centerX - entCenterX, centerY - entCenterY);

            if (dist < TILE_SIZE * 1.5) {
                nearby = true;
                ent.highlight = true;
            } else {
                ent.highlight = false;
            }
        }
        
        const notif = document.getElementById('notification');
        notif.style.opacity = nearby ? '1' : '0';
    }

    function interact() {
        const centerX = player.x + player.width/2;
        const centerY = player.y + player.height/2;

        let target = null;
        let minDist = Infinity;

        for (let ent of entities) {
            const entCenterX = (ent.x * TILE_SIZE) + (TILE_SIZE/2);
            const entCenterY = (ent.y * TILE_SIZE) + (TILE_SIZE/2);
            const dist = Math.hypot(centerX - entCenterX, centerY - entCenterY);

            if (dist < TILE_SIZE * 1.8 && dist < minDist) {
                minDist = dist;
                target = ent;
            }
        }

        if (target) {
            openModal(target);
        }
    }

    function openModal(entity) {
        isModalOpen = true;
        keys.w = keys.a = keys.s = keys.d = false;

        const modal = document.getElementById('modal');
        const title = document.getElementById('modal-title');
        const content = document.getElementById('modal-content');

        title.innerHTML = entity.title;
        content.innerHTML = entity.content;
        
        const colors = {
            chest: 'text-yellow-400',
            statue: 'text-green-400',
            trophy: 'text-yellow-500',
            npc: 'text-blue-400',
            mailbox: 'text-red-400',
            sign: 'text-white',
            bookshelf: 'text-orange-400'
        };
        title.className = `text-4xl pixel-text tracking-wide ${colors[entity.type] || 'text-white'}`;

        modal.style.display = 'block';
    }

    function closeModal() {
        isModalOpen = false;
        document.getElementById('modal').style.display = 'none';
    }

    /**
     * DRAW
     */
    function draw() {
        // Clear with Water Color (fixes black space)
        ctx.fillStyle = '#3498db';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        ctx.translate(-Math.floor(camera.x), -Math.floor(camera.y));

        // Draw Map
        const startCol = Math.floor(camera.x / TILE_SIZE);
        const endCol = startCol + (canvas.width / TILE_SIZE) + 1;
        const startRow = Math.floor(camera.y / TILE_SIZE);
        const endRow = startRow + (canvas.height / TILE_SIZE) + 1;
        
        for (let y = 0; y < MAP_HEIGHT; y++) {
            for (let x = 0; x < MAP_WIDTH; x++) {
                // Optimization: Skip tiles outside view
                const px = x * TILE_SIZE;
                const py = y * TILE_SIZE;
                if (px + TILE_SIZE < camera.x || px > camera.x + canvas.width ||
                    py + TILE_SIZE < camera.y || py > camera.y + canvas.height) continue;

                const tile = worldMap[y][x];

                if (tile === 0) { // Grass
                    ctx.fillStyle = '#4a854a'; 
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    ctx.fillStyle = '#5ba65b'; 
                    ctx.fillRect(px + 4, py + 4, 4, 4);
                    ctx.fillRect(px + 20, py + 30, 4, 4);
                } else if (tile === 1) { // Water (Island coast)
                    // We draw this to blend with background
                    ctx.fillStyle = '#3498db';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    // Waves
                    const time = Date.now() / 400;
                    const offset = Math.sin(time + x/2 + y/2) * 4;
                    ctx.fillStyle = '#5dade2';
                    ctx.fillRect(px + 5 + offset, py + 10, 20, 2);
                    ctx.fillRect(px + 20 - offset, py + 30, 15, 2);
                } else if (tile === 2) { // Path
                    ctx.fillStyle = '#9aa567';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    ctx.fillStyle = '#8a9557'; 
                    ctx.fillRect(px + 10, py + 10, 2, 2);
                    ctx.fillRect(px + 30, py + 35, 2, 2);
                } else if (tile === 3) { // Wood
                    ctx.fillStyle = '#5d4037';
                    ctx.fillRect(px, py, TILE_SIZE, TILE_SIZE);
                    ctx.strokeStyle = '#4e342e';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(px, py+12); ctx.lineTo(px+48, py+12);
                    ctx.moveTo(px, py+24); ctx.lineTo(px+48, py+24);
                    ctx.moveTo(px, py+36); ctx.lineTo(px+48, py+36);
                    ctx.stroke();
                }
            }
        }

        // Shadows
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        ctx.beginPath();
        ctx.ellipse(player.x + player.width/2, player.y + player.height - 2, 10, 5, 0, 0, Math.PI * 2);
        ctx.fill();

        entities.forEach(ent => {
             ctx.beginPath();
             ctx.ellipse(ent.x * TILE_SIZE + TILE_SIZE/2, ent.y * TILE_SIZE + TILE_SIZE - 2, 14, 6, 0, 0, Math.PI * 2);
             ctx.fill();
        });

        // Entities
        entities.forEach(ent => {
            const px = ent.x * TILE_SIZE;
            const py = ent.y * TILE_SIZE;
            drawEntitySprite(ent, px, py);
            
            if (ent.highlight) {
                const bounce = Math.sin(Date.now() / 150) * 3;
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.moveTo(px + TILE_SIZE/2, py - 10 + bounce);
                ctx.lineTo(px + TILE_SIZE/2 - 5, py - 18 + bounce);
                ctx.lineTo(px + TILE_SIZE/2 + 5, py - 18 + bounce);
                ctx.fill();
            }
        });

        drawPlayerSprite();

        ctx.restore();
    }

    function drawEntitySprite(ent, x, y) {
        if (ent.type === 'chest') {
            ctx.fillStyle = ent.color;
            ctx.fillRect(x + 4, y + 14, 40, 26);
            ctx.fillStyle = '#d4af37'; 
            ctx.fillRect(x + 4, y + 20, 40, 4);
            ctx.fillRect(x + 18, y + 18, 12, 10); 
            ctx.strokeStyle = 'black'; ctx.lineWidth = 1; ctx.strokeRect(x+4,y+14,40,26);
        } 
        else if (ent.type === 'sign') {
            ctx.fillStyle = '#6d4c41'; ctx.fillRect(x + 20, y + 24, 8, 24);
            ctx.fillStyle = '#a1887f'; ctx.fillRect(x + 4, y + 8, 40, 24);
            ctx.fillStyle = '#3e2723'; ctx.fillRect(x + 8, y + 14, 24, 2); ctx.fillRect(x + 8, y + 20, 18, 2);
            ctx.strokeStyle = '#3e2723'; ctx.lineWidth = 1; ctx.strokeRect(x+4,y+8,40,24);
        }
        else if (ent.type === 'statue') {
            ctx.fillStyle = '#7f8c8d'; ctx.fillRect(x + 8, y + 32, 32, 12);
            ctx.fillStyle = '#bdc3c7'; 
            ctx.beginPath(); ctx.arc(x + 24, y + 16, 10, 0, Math.PI * 2); ctx.fill();
            ctx.fillRect(x + 14, y + 24, 20, 14); 
        }
        else if (ent.type === 'trophy') {
            ctx.fillStyle = '#f1c40f';
            ctx.beginPath(); ctx.moveTo(x + 14, y + 36); ctx.lineTo(x + 34, y + 36); ctx.lineTo(x + 30, y + 20); ctx.lineTo(x + 18, y + 20); ctx.fill();
            ctx.beginPath(); ctx.arc(x + 24, y + 20, 10, 0, Math.PI, false); ctx.fill();
            ctx.fillStyle = '#8e44ad'; ctx.fillRect(x + 12, y + 36, 24, 8);
        }
        else if (ent.type === 'mailbox') {
            ctx.fillStyle = '#7f8c8d'; ctx.fillRect(x + 20, y + 24, 8, 24);
            ctx.fillStyle = ent.color; 
            ctx.beginPath(); ctx.arc(x + 24, y + 12, 14, Math.PI, 0); ctx.lineTo(x + 38, y + 26); ctx.lineTo(x + 10, y + 26); ctx.fill();
            ctx.fillStyle = '#c0392b'; ctx.fillRect(x+10, y+12, 28, 14);
            ctx.fillStyle = '#e74c3c'; ctx.fillRect(x+38, y+14, 4, 10);
        }
        else if (ent.type === 'npc') {
            ctx.fillStyle = ent.color; ctx.fillRect(x + 10, y + 18, 28, 24);
            ctx.fillStyle = '#ffccaa'; ctx.fillRect(x + 14, y + 4, 20, 18);
            ctx.fillStyle = '#333'; ctx.fillRect(x + 18, y + 10, 4, 4); ctx.fillRect(x + 28, y + 10, 4, 4);
        }
        else if (ent.type === 'bookshelf') {
            ctx.fillStyle = '#8e44ad'; ctx.fillRect(x + 8, y + 12, 32, 32); // Main shelf
            ctx.fillStyle = '#6c3483'; ctx.fillRect(x + 4, y + 8, 40, 4); // Top trim
            // Books
            const bookColors = ['#e74c3c', '#3498db', '#f1c40f', '#2ecc71'];
            for(let i=0; i<4; i++) {
                ctx.fillStyle = bookColors[i];
                ctx.fillRect(x + 10 + (i*6), y + 16, 4, 10);
                ctx.fillRect(x + 10 + (i*6), y + 30, 4, 10);
            }
        }
    }

    function drawPlayerSprite() {
        const px = player.x;
        const py = player.y;

        const wobble = player.moving ? Math.sin(player.frame) * 2 : 0;
        const legOffset = player.moving ? Math.sin(player.frame * 2) * 5 : 0;

        ctx.fillStyle = '#2c3e50';
        ctx.fillRect(px + 8, py + 24, 6, 8 + legOffset);
        ctx.fillRect(px + 18, py + 24, 6, 8 - legOffset);

        ctx.fillStyle = player.color;
        ctx.fillRect(px + 4, py + 12 + wobble, 24, 16);

        ctx.fillStyle = '#ffccaa';
        ctx.fillRect(px + 6, py - 2 + wobble, 20, 16);
        
        ctx.fillStyle = '#d35400';
        ctx.fillRect(px + 4, py - 6 + wobble, 24, 6);
        
        ctx.fillStyle = '#000';
        if (player.direction === 'down' || player.direction === 's') {
            ctx.fillRect(px + 10, py + 4 + wobble, 4, 4);
            ctx.fillRect(px + 20, py + 4 + wobble, 4, 4);
        } else if (player.direction === 'right' || player.direction === 'd') {
            ctx.fillRect(px + 20, py + 4 + wobble, 4, 4);
        } else if (player.direction === 'left' || player.direction === 'a') {
            ctx.fillRect(px + 8, py + 4 + wobble, 4, 4);
        }
    }

    function gameLoop(time) {
        const dt = time - lastTime;
        lastTime = time;

        update(dt);
        draw();
        
        requestAnimationFrame(gameLoop);
    }

    window.onload = init;

</script>
</body>
</html>


